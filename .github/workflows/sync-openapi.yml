name: Sync OpenAPI Spec

on:
  repository_dispatch:
    types: [openapi-updated]
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            6.0.x
            8.0.x
            10.0.x

      - name: Generate token from GitHub App
        id: token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.WIZARD_APP_ID }}
          private-key: ${{ secrets.WIZARD_PRIVATE_KEY }}
          owner: invokation-games
          repositories: |
            ivk-skill
            dotnet-sdk

      - name: Download latest OpenAPI spec
        env:
          GH_TOKEN: ${{ steps.token.outputs.token }}
        run: |
          # Get latest api-v* release tag
          TAG=$(gh release list --repo invokation-games/ivk-skill --json tagName \
            | jq -r '[.[] | select(.tagName | startswith("api-v"))][0].tagName')

          echo "Latest API release: $TAG"

          # Download the asset and rename to expected filename
          gh release download "$TAG" --repo invokation-games/ivk-skill --pattern "openapi.json"
          mv openapi.json ivk-skill-openapi.json

      - name: Check for changes
        id: diff
        run: |
          if git diff --quiet ivk-skill-openapi.json; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Generate SDK
        if: steps.diff.outputs.changed == 'true'
        run: |
          # Remove old generated files
          rm -rf src/Invokation.Skill.Sdk/Api src/Invokation.Skill.Sdk/Client src/Invokation.Skill.Sdk/Model

          # Generate new SDK
          docker run --rm \
            -v "${PWD}:/local" \
            --user "$(id -u):$(id -g)" \
            openapitools/openapi-generator-cli:v7.12.0 generate \
            -i /local/ivk-skill-openapi.json \
            -c /local/openapi-generator-config.yaml \
            -o /local/generated

          # Copy generated files
          cp -r generated/src/Invokation.Skill.Sdk/Api src/Invokation.Skill.Sdk/
          cp -r generated/src/Invokation.Skill.Sdk/Client src/Invokation.Skill.Sdk/
          cp -r generated/src/Invokation.Skill.Sdk/Model src/Invokation.Skill.Sdk/

          # Cleanup
          rm -rf generated

      - name: Build and Test
        if: steps.diff.outputs.changed == 'true'
        run: |
          dotnet build --configuration Release
          dotnet test --configuration Release

      - name: Create Pull Request
        if: steps.diff.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ steps.token.outputs.token }}
          commit-message: "feat: sync openapi spec"
          title: "feat: sync openapi spec"
          body: |
            Automated sync of OpenAPI specification from latest api release.
          branch: chore/sync-openapi
          delete-branch: true
